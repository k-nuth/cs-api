<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Target Name="GetKnuthCAPI">

    <PropertyGroup Condition=" ! (Exists('kth-c-api.dll') Or Exists('libkth-c-api.so') Or Exists('libkth-c-api.dylib')) ">
        <HaveToExecConan>True</HaveToExecConan>
    </PropertyGroup>
    <PropertyGroup Condition=" (Exists('kth-c-api.dll') Or Exists('libkth-c-api.so') Or Exists('libkth-c-api.dylib')) ">
        <HaveToExecConan>False</HaveToExecConan>
    </PropertyGroup>

    <Message Text="Operating System: $(OS)"/>
    <Message Text="HaveToExecConan: $(HaveToExecConan)"/>
    <Message Text="Knuth Channel:   $(KNUTH_CHANNEL)"/>
    <Message Text="Knuth Version:   $(KNUTH_VERSION)"/>
    <Message Text="Knuth Currency:  $(KNUTH_CURRENCY)"/>
    <Message Text="Knuth March ID:  $(KNUTH_MARCH_ID)"/>
    
    <Exec Command="conan config install https://github.com/k-nuth/ci-utils/raw/master/conan/config.zip" 
        ContinueOnError="WarnAndContinue"
        Condition="'$(HaveToExecConan)'=='True'" />

    <WriteLinesToFile
      File="conanfile.txt" Lines="[requires];c-api/$(KNUTH_VERSION)@kth/$(KNUTH_CHANNEL);[generators];cmake;[options];c-api:shared=True;c-api:currency=$(KNUTH_CURRENCY);c-api:db=full;c-api:march_id=$(KNUTH_MARCH_ID);[imports];bin, *.dll    -> .;lib, *.so    -> .;lib, *.dylib    -> ."
      Overwrite="true" Condition="'$(HaveToExecConan)'=='True'"/>

    <Exec Command="conan install . --install-folder=. --update" 
        Condition=" '$(OS)' != 'Windows_NT' And '$(HaveToExecConan)'=='True' " />
    <Exec Command="conan install . --install-folder=. -s compiler=&quot;Visual Studio&quot; -s compiler.version=16 --update" 
        Condition=" '$(OS)' == 'Windows_NT' And '$(HaveToExecConan)'=='True' "/>
   
    <Message Text="OS = $(OS)" />
    <Copy SourceFiles="kth-c-api.dll" DestinationFiles="$(OutDir)libkth-c-api.dll" Condition=" '$(OS)' == 'Windows_NT' "/>
    <Copy SourceFiles="libkth-c-api.so" DestinationFiles="$(OutDir)libkth-c-api.so" Condition="Exists('libkth-c-api.so')"/>
    <Copy SourceFiles="libkth-c-api.dylib" DestinationFiles="$(OutDir)libkth-c-api.dylib" Condition="Exists('libkth-c-api.dylib')"/>
  </Target>
</Project>
